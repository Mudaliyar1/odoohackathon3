<%- include('../partials/flash') %>

<div class="container mt-4">
    <h1 class="mb-4 text-primary fw-bold">Product Kanban Board</h1>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="/products/create" class="btn btn-primary">Add New Product</a>
        <a href="/products" class="btn btn-info">Switch to Table View</a>
    </div>

    <div class="kanban-board d-flex flex-nowrap overflow-auto">
        <% Object.keys(productsByStatus).forEach(status => { %>
            <div class="kanban-column mx-2 p-3 bg-light rounded shadow-sm" data-status="<%= status %>">
                <h4 class="text-capitalize mb-3"><%= status.replace(/_/g, ' ') %> (<%= productsByStatus[status].length %>)</h4>
                <div class="kanban-cards" id="kanban-<%= status %>">
                    <% productsByStatus[status].forEach(product => { %>
                        <div class="card kanban-card mb-2" data-id="<%= product._id %>">
                            <div class="card-body">
                                <h5 class="card-title"><%= product.name %></h5>
                                <p class="card-text">SKU: <%= product.sku %></p>
                                <p class="card-text">Category: <%= product.category %></p>
                                <p class="card-text">Quantity: <%= product.availableQuantity %></p>
                                <p class="card-text">Warehouse: <%= product.warehouse ? product.warehouse.name : 'N/A' %></p>
                                <a href="/products/<%= product._id %>" class="btn btn-sm btn-info">View</a>
                                <a href="/products/<%= product._id %>/edit" class="btn btn-sm btn-warning">Edit</a>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        <% }); %>
    </div>
</div>

<style>
    .kanban-board {
        gap: 1rem;
    }
    .kanban-column {
        min-width: 300px;
        max-width: 300px;
        flex-shrink: 0;
        border: 1px solid #ddd;
    }
    .kanban-card {
        cursor: grab;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const kanbanColumns = document.querySelectorAll('.kanban-cards');

        kanbanColumns.forEach(column => {
            new Sortable(column, {
                group: 'kanban',
                animation: 150,
                onEnd: function (evt) {
                    const productId = evt.item.dataset.id;
                    const newStatus = evt.to.closest('.kanban-column').dataset.status;
                    
                    // TODO: Send AJAX request to update product status
                    // console.log(`Product ${productId} moved to status ${newStatus}`);
                    fetch('/products/updateStatus', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ productId, newStatus }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Product status updated successfully:', data.product);
                            // Optionally, update UI further or show a success message
                        } else {
                            console.error('Failed to update product status:', data.message);
                            // Optionally, revert UI change or show an error message
                        }
                    })
                    .catch(error => {
                        console.error('Error updating product status:', error);
                        // Optionally, revert UI change or show an error message
                    });
                },
            });
        });
    });
</script>